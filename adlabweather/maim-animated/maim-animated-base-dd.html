<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> Dunkin' Donuts Matcha Latte MAIM</title>
    <script src="//media.admob.com/api/v1/google_mobile_app_ads.js"></script>
    <script>
    var labAd = {
      adCond: null,
      mode: null,

      meta:{
        jiraID: 'tcl0000', //Example: The name of the JIRA ID
        projectName: 'The Creative Lab - Q4 20 - State Farm', //CVS Stores Preseason (Week Ahead SPON)
        advertiser: 'Dunkin Donuts', // Ex: 'mcdonalds'
        placement: '', // Ex: 'ros-shopper-moms'
        created: '03-09-2020', // Ex: '08-23-2018'
        modified: '08-03-2022', // change when base code changes to current date of change
        designer: 'MMedina', // Ex: 'coreyd'
        dev: 'JamesB' //Ex: 'dks'
      },
      product:{
        productName:'MAIM - Mobile App Integrated Marquee (Animated)', // Abrev. + Full name of Product
        version: 'v2.3', //This will reflect the Github Version on the stable branch
        type: 'animated', // 'static', 'animated'
        interactive: '', // EX: 'locator', 'vertical-video', 'swipe-carousel', etc.
        adaptor: 'base-conditions',  //EX: 'temp-range', 'temp-comparison', 'countdown', etc.
        dimensions:{
          ad:{
            //default for milli devices
            sm: {width:320, height:180},

            //default for kilo devices
            md: {width:360, height:180},
            lg: {width:360, height:180},
            xl: {width:360, height:180}
          },
          bg:{
            //default for milli devices
            sm: {width:400, height:660},

            //default for kilo devices
            md: {width:500, height:800},
            lg: {width:500, height:800},
            xl: {width:500, height:800}
          }
        },
        platforms: ['android', 'ios']// 'ios', 'android', 'web', 'mw'
      },

      appBg: { // object passed to AppEvent - do not add new properties to this object.
        baseURL: '',
        imgID: ''
      },
      appBgVid: { // object passed to AppEvent - do not add new properties to this object.
        vidURL: '5965c2e0-b785-4298-ad56-e27a68afad0a/400x660-bg-dunkin-copy-cld-d@2x_HighRes_avc_mpeg4_1000kbps.mp4' // Ex:'414x210-clear_day@1x.mp4' - @1x filename only for initial assignment. labAd.dir prepended before sending to app event.
      },
      deviceSize:'sm', // sm, md, lg, xl
      dir: 'https://v.w-x.co/digital_video/The_Weather_Channel_-_Reach_Engine/',
      dpr: window.devicePixelRatio,
      default: {
        cnd: 'cld',
        dynght: 'D',
        img:'https://s.w-x.co/cl/test/1x1_test.png', // using transparent png since everything is baked into BG image
        previewMode: 'o',
        reason:'na' // 'na' is default
      },
      displayed: false, // flag indicating showAd or showDefault has executed successfully.
      selected: {        // for tracking selected values
        adImages:[],
        bgEvent:'adBgVid', // Ex: 'adBg' or 'adBgVid' - set based on ad concept.
        scenario: 'na'
      },
      els: {},
      errors: [],
      imgs: {},
      log: logInfo,
      logLevel: 1, // 0 = none, 1 = labAd, 2 = everything
      logs: [],
      macros: { // macros populated by GAM when ad is served
        cnd: "%%PATTERN:cnd%%", // current condition.
        dynght: "%%PATTERN:dynght%%", // day or night? Possible values: 'D', 'N'
        height: "%%HEIGHT%%", // ad slot height
        width: "%%WIDTH%%", // ad slot width
        plat: "%%PATTERN:plat%%", // platform. Used for tracking
        timeframe: "%%PATTERN:tf%%", // timeframe. Used for tracking
        gamClick: "%%CLICK_URL_UNESC%%", // Google Ad Manager click track URL
        gamPreview: '%%PREVIEW_MODE%%',
        cid: "%ecid!", // creative id
        lid: "%eaid!", // line item id
        ord: '%%CACHEBUSTER%%'
      },
      preview:{
        css:{id:'previewCSS', href:'preview-maim-ani-v4.css', dir:'hostedcss'},
        dirs:{
          hostedAssets:'https://s.w-x.co/cl/wxcl/preview-mode/maim/assets/v2/',
          hostedjs:'https://s.w-x.co/cl/wxcl/preview-mode/maim/js/',
          hostedcss:'https://s.w-x.co/cl/wxcl/preview-mode/maim/css/',
          localAssets:'preview-mode/assets/v2/',
          localjs:'preview-mode/js/',
          localcss:'preview-mode/css/'
        },
        images:[
          // NOTE: images.src values use split('-'). Extraneous '-' in filenames will cause issues.
          // Standard Preview Images & Conditions
  				{id: 'logo', type:'logo', src: 'all-logo-watson-ads.png', dir: 'hostedAssets'},
  				{id: 'device', type:'device', src: 'lg-device.png', dir: 'hostedAssets'},

  				//for devices uis'
  				{id: 'ui-clr+D', type:'ui', src: 'lg-ui-clear-day.png', dir: 'hostedAssets'},
  				{id: 'ui-clr+N', type:'ui', src: 'lg-ui-clear-night.png', dir: 'hostedAssets'},
  				{id: 'ui-cld+D', type:'ui', src: 'lg-ui-cloudy-day.png', dir: 'hostedAssets'},
  				{id: 'ui-cld+N', type:'ui', src: 'lg-ui-cloudy-night.png', dir: 'hostedAssets'},
  				{id: 'ui-rain+D', type:'ui', src: 'lg-ui-rainy-day.png', dir: 'hostedAssets'},
  				{id: 'ui-rain+N', type:'ui', src: 'lg-ui-rainy-night.png', dir: 'hostedAssets'},
  				{id: 'ui-snow+D', type:'ui', src: 'lg-ui-snowy-day.png', dir: 'hostedAssets'},
  				{id: 'ui-snow+N', type:'ui', src: 'lg-ui-snowy-night.png', dir: 'hostedAssets'}
        ]
      },
      promises: {},
      test: {},
      time: {
        log:{},
        stamp:0 // most recent getTime. Updated when logTime is called.
      },
      tracking: {
        clickTag: 'https://weather.com/', // Ex: 3rd party click tracker
        imp3rdParty: 'https://s.w-x.co/cl/test/1x1_test.png' // Ex: 3rd party impression tracker img src
      }
    }

    function initAd() {
      try {
        // init date & time
        labAd.time.date = new Date();
        logTime('initAd');

        // init labAd props and els - especially those needed for tracking and timing operations
        labAd.els.labAdDiv = document.getElementById('labAdDiv');
        labAd.els.labTracking = document.getElementById('labTracking');

        // get ad mode to determine if vars populated by macros or test hash
        labAd.mode = getAdMode();

        // populate vars from the correct source for mode
        initAdMode(labAd.mode);

        // determine adCond based on cnd and dynght values
        labAd.adCond = labAd.macros.cnd + '-' + labAd.macros.dynght;

        // init loader method for scripts, imgs and link els
        initLoader();

        // if Preview Mode, load resources needed, then init Preview Mode.
        if (labAd.mode === 'preview' || labAd.mode === 'gamPreview') {
          // group loader calls in array so they share the same callback
          var sPathjs = labAd.preview.dirs.hostedjs; // .standard, .customDir or .local
          var sPathcss = labAd.preview.dirs.hostedcss; // .standard, .customDir or .local
          var aPreviewPromises = [
            labAd.loader.js({src: sPathjs + 'preview-maim-v3.js', append: true}),
            labAd.loader.css({src: sPathcss + 'preview-maim-ani-v4.css', append: true})
          ];

          // use promise.all to execute callback when all promises are fulfilled
          labAd.promises.previewResources = Promise.all(aPreviewPromises).then(function(result) {

            // log success result
            labAd.log({label:'aPreviewPromises fulfilled. ', detail: result, type: 'log'});

            // complete init PreviewMode now that resources are loaded
            labAd.preview.init();

          }).catch(function(err) {
            labAd.log({label: 'aPreviewPromises file load error: ', detail: err, type: 'error', isFatal: true });
          });
        }else{ // else proceed to display using ad served
          initDisplay(labAd.adCond);
        }

      } catch (err) {
        labAd.log({label: 'initAd error: ', detail: err, type: 'error', isFatal: true });
      }
    }

    function initAdMode(sMode){
      try {
        var result = '';
        // Cases below should define adjustments needed for test modes supported by ad.
        switch (sMode) {
          case 'preview':
          case 'gamPreview':
            // clear GAM click macro so clicks will work in test modes
            labAd.macros.gamClick = "";
            // assign values from HashParts - hash order is adstest + cnd + dynght + deviceSize + DPR + previewMode
            labAd.macros.cnd = labAd.test.HashParts[1];
            labAd.macros.dynght = labAd.test.HashParts[2].toUpperCase();
            labAd.deviceSize = labAd.test.HashParts[3].toLowerCase();

            // get dpr from hash if not undefined, otherwise use window property
            labAd.dpr = (labAd.test.HashParts[4] != undefined) ? Number(labAd.test.HashParts[4]) : window.devicePixelRatio;

            // adjust meta height
            if (labAd.deviceSize !== 'sm') {
              labAd.meta.width = 360;
            }
            break;
          default: // covers 'live' and 'none'
            labAd.deviceSize = getDeviceSize();
            break;
        }

        // log result
        result = labAd.mode + ' activated';
        labAd.log({label: 'initAdMode ', detail: result, type: 'log' });
      } catch (err) {
        labAd.log({label: 'initAdMode error: ', detail: err, type: 'error', isFatal: false });
      }
    }

    function initDisplay(sCond){
      logTime('initDisplay');
      try {
        // start the display routine by firing appEvent, selecting files, loading AD & BG images

        // fire adIM event asap so the app knows to push the feed card down
        fireAppEvent('adIM', {});

        // select files needed for AD & BG display.
        labAd.selected = fileSelection(sCond);

        // 1: showBg - should be called first since it cannot be preloaded.
        // labAd.selected.bg properties will be used to package & send .
        showBg(labAd.selected.bg);

        // create an array of img promises to be loaded together
        labAd.promises.adImages = [];
        // create a loader.img instance for each selected img
        labAd.selected.adImages.forEach(function(imgObj){
          // add each individual promise to the collection
          labAd.promises.adImages.push(labAd.loader.img(imgObj));
        });

        // use promise.all to execute callback when all promises are fulfilled
        labAd.promises.allAdImages = Promise.all(labAd.promises.adImages).then(function(aLoadedImages) {
          // log success aLoadedImages
          labAd.log({label:'labAd.promises.allAdImages fulfilled. ', detail: aLoadedImages, type: 'log'});

          // call showAd and pass the successfully loaded Image els that still
          // need to be added to the DOM
          showAd(aLoadedImages);
        }).catch(function(err) {
          labAd.log({label: 'labAd.promises.allAdImages file load error: ', detail: err, type: 'error', isFatal: true });
        });

        labAd.log({label: 'initDisplay ', detail: sCond, type: 'log' });
      } catch (err) {
        labAd.log({label: 'initDisplay error: ', detail: err, type: 'error', isFatal: false });
      }
    }

    function initLoader(){
      try {
        // initLoader: creates labAd.loader - which is a method that returns a function for loading resources using a Promise to determine success or failure. Currently supports script, link & img els. All different types can be loaded with the same callback.
        logTime('initLoader');
        labAd.loader = (function() {
          // Function which returns a function: https://davidwalsh.name/javascript-functions
          function _load(tag) {
            return function(loadObj) {
              // This promise will be used by Promise.all to determine success or failure
              return new Promise(function(resolve, reject) {
                var element;
                var parent = 'body';
                var attr = 'src';

                // Adjust element type & attributes depending on tag type
                switch(tag) {
                  case 'img':
                    element = new Image();
                    element.id = loadObj.id;
                    element.src = loadObj.src;
                    break;
                  case 'script':
                    element = document.createElement(tag);
                    element.async = true;
                    break;
                  case 'link':
                    element = document.createElement(tag);
                    element.type = 'text/css';
                    element.rel = 'stylesheet';
                    attr = 'href';
                    parent = 'head';
                    break;
                }

                // Important success and error for the promise
                element.onload = function() {
                  labAd.log({label: tag + ' loaded ', detail: {lO:loadObj, el:element, t:tag}, type: 'log' });
                  // resolve the promise & return the element
                  resolve(element);
                };
                element.onerror = function(err) {
                  labAd.errors.push(err);
                  reject(err);
                };


                // if append is true, element needs to be added to DOM immediately
                // doing this & applying src will cause the resource to load but
                // the Promise controls what happens next.
                if (loadObj.append) {
                  // apply the source & add to DOM
                  element[attr] = loadObj.src;
                  document[parent].appendChild(element);
                }

              });
            };
          }

          return {
            css: _load('link'),
            js: _load('script'),
            img: _load('img')
          }
        })();

        labAd.log({label: 'initLoader ', detail: labAd.loader, type: 'log' });
      } catch (err) {
        labAd.log({label: 'initLoader error: ', detail: err, type: 'error', isFatal: false });
      }
    }

    function exitClick(event) {
      try {
        event.preventDefault();
        var id = event.target.id;
        var url = labAd.tracking.clickTag;
        var target = "_blank";
        var clickTime = logTime('exitClick');
        var btnPos = labAd.els.btnInv.getBoundingClientRect();
        labAd.log({label: 'exitClick from: ' + id, detail: url, type: 'log' });

        // launch clickthrough window
        window.open(labAd.macros.gamClick + url, target);

      } catch (err) {
        labAd.log({label: 'exitClick error: ', detail: err, type: 'error', isFatal: false });
      }
    }

    function fileSelection(sCond){
      try {
        // selected is a return object containing all relevant details needed to
        // complete the ad display process.
        var selected = {
          adImages:[], // array of AD images to be loaded
          bg:{
            eventName:'',  // string name AppEvent: 'adBg' or 'adBgVid'
            fileName:'',  // string filename of the selected BG image or video
            logicalWidth: 400, // logical (aka 1x) width of BG asset
            logicalHeight: 660,// logical (aka 1x) height of BG asset
            loopCount: 3 // number of times to loop BG video
          },
          scenario: '' // string name representing the selected scenario
        };

        /////////////////////////////////////////////////////////
        // 1: Assign values used for most or all scenarios //
        /////////////////////////////////////////////////////////
        // NOTE: since there's only one image in the AD region for this creative,
        // its also assigned as the static default - which is why the line below
        // references that instead of just using the filename string. Also, the
        // id is being set to 'btnInv' so it will inherit the click handler that
        // that might be assigned to a transparent png in a more complex ad.
        selected.adImages.push( imgObj('btnInv', labAd.default.img) );
        selected.bg.eventName = 'adBgVid';

        //////////////////////////////////////////////
        // 2: Assign BG image/video to appBg or appBgVid //
        //////////////////////////////////////////////

        sCond = sCond.toLowerCase();
        switch (sCond) {
          case 'sun-d':
          case 'clr-d':
            selected.scenario = 'Clear Day';
            selected.bg.fileName = 'bde5532e-c1fb-44e1-b159-1b424d759c84/400x660-bg-dunkin-copy-clr-d@2x_HighRes_avc_mpeg4_1000kbps.mp4';

            break;
          case 'sun-n':
          case 'clr-n':
            selected.scenario = 'Clear Night';
            selected.bg.fileName = '3f0e94cd-d464-492d-9f7d-625c2d7f5135/400x660-bg-dunkin-copy-clr-n@2x_HighRes_avc_mpeg4_1000kbps.mp4';

            break;
          case 'cld-n':
          case 'pcld-n':
            selected.scenario = 'Cloudy Night';
            selected.bg.fileName = 'c094d434-dd9b-484b-8a9d-cce6cbd6bf93/400x660-bg-dunkin-copy-cld-n@2x_HighRes_avc_mpeg4_1000kbps.mp4';

            break;
          case 'rain-d':
          case 'thdr-d':
            selected.scenario = 'Rainy Day';
            selected.bg.fileName = 'df06aa83-c2aa-4c86-8f12-437887600023/400x660-bg-dunkin-copy-rain-d@2x_HighRes_avc_mpeg4_1000kbps.mp4';

            break;
          case 'rain-n':
          case 'thdr-n':
            selected.scenario = 'Rainy Night';
            selected.bg.fileName = '8267fabf-caa6-449a-b447-3837d366ff93/400x660-bg-dunkin-copy-rain-n@2x_HighRes_avc_mpeg4_1000kbps.mp4';

            break;
          case 'snow-d'://Wintery Day
          case 'ice-d': //Ice Day
            selected.scenario = 'Wintry/Icy Day';
            selected.bg.fileName = '92805e81-23c9-4faa-aa01-9ccef04b1b45/400x660-bg-dunkin-copy-snow-d@2x_HighRes_avc_mpeg4_1000kbps.mp4';

            break;
          case 'snow-n'://Wintery Night
          case 'ice-n': //Ice Night
            selected.scenario = 'Wintry/Icy Night';
            selected.bg.fileName = 'b04c227a-dbf1-4435-aac3-168193a500bd/400x660-bg-dunkin-copy-snow-n@2x_HighRes_avc_mpeg4_1000kbps.mp4';

            break;
          default:

            //Kylie Prevatt - 03/31/22
            //Added conditional logic to display correct D/N version of default creative
            if (labAd.macros.dynght == 'n' || labAd.macros.dynght == 'N'){
              selected.scenario = 'Cloudy Night - default: '+ sCond;
              selected.bg.fileName = 'c094d434-dd9b-484b-8a9d-cce6cbd6bf93/400x660-bg-dunkin-copy-cld-n@2x_HighRes_avc_mpeg4_1000kbps.mp4';
            } else {
              selected.scenario = 'Cloudy Day - default: '+ sCond;
              selected.bg.fileName = '5965c2e0-b785-4298-ad56-e27a68afad0a/400x660-bg-dunkin-copy-cld-d@2x_HighRes_avc_mpeg4_1000kbps.mp4';
            }
            break;
        }

        // process selected BG filename dimensions by passing through setSrcSize
        selected.bg.fileName = setSrcSize(selected.bg.fileName);

        ////////////////////////////////////////
        // 3: Apply logical BG img dimensions //
        ////////////////////////////////////////
        if (labAd.deviceSize !== 'sm') {
          selected.bg.logicalWidth = 500;
          selected.bg.logicalHeight = 800;
        }

        // log results
        labAd.log({label: 'fileSelection ', detail: selected, type: 'log' });

        ///////////////////////////////////
        // 4: return object with details //
        ///////////////////////////////////
        return selected;
      } catch (err) {
        labAd.log({label: 'fileSelection error: ', detail: err, type: 'error', isFatal: true });
      }
    }

    function fireAppEvent(sEventName, oProps) {
      try {
        logTime('fireAppEvent-'+ sEventName);
        // stringify oProps object for use in dispatchAppEvent
        var payload = JSON.stringify(oProps);
        admob.events.dispatchAppEvent(sEventName, payload);

        labAd.log({label: 'fireAppEvent ' + sEventName, detail: oProps, type: 'log' });
      } catch (err) {
        labAd.log({label: 'fireAppEvent error: '+ sEventName, detail: err, type: 'error', isFatal: false });
      }
    }

    function getImpPixel(sURL, sEventName) {
      try {
        var regexp = /(https?:\/\/[^\s]+)/g; // begins with http:// or https://
        if (regexp.exec(sURL)) {
          // if url is valid, add tracking pixel to labTracking
          var pixel = document.createElement('img');
          pixel.src = sURL;
          pixel.alt = sEventName;
          // add new img to tracking div
          labAd.els.labTracking.appendChild(pixel);

          // log success
          labAd.log({label: 'getImpPixel: ' + sEventName, detail: pixel, type: 'log' });
        } else {
          // log error for invalid URL.
          var eO = {message:'sEventName: ' + sEventName};
          labAd.log({label: 'getImpPixel - invalid URL: ' + sURL, detail: eO, type: 'error', isFatal: false });
        }
      } catch (err) {
        labAd.log({label: 'getImpPixel error: ', detail: err, type: 'error', isFatal: false });
      }
    }

    function getAdMode() {
      try {
        labAd.test.HashParts = getTestHash();
        // if the zero index === adstest, we go into test mode
        if (labAd.test.HashParts[0] === "adstest") {
            labAd.test.mode = 'preview';
        } else if (labAd.macros.gamPreview === 'true') { // Macro will return true for GAM Creative Preview. Original macro token will be intact during local dev.
            labAd.test.mode = 'gamPreview';
        } else {
            labAd.test.mode = 'live';
        }

        labAd.log({label: 'getAdMode: ' + labAd.test.mode, detail: labAd.test, type: 'log' });
        return labAd.test.mode;
      } catch (err) {
        labAd.log({label: 'getAdMode error: ', detail: err, type: 'error', isFatal: true });
      }
    }

    function getDeviceSize(){
      try {
        // return a value for labAd.deviceSize based on WIDTH of ad slot size
        // requested. For milli devices, size will be 320x180. All other devices
        // will be 360x180.

        // default to small & adjust up if needed
        var sz = 'sm';
        if (labAd.macros.width !== '320') {
          // if macro width is not small, return lg
          sz = 'lg';
          // TODO: any reason (aside from PreviewMode) to pass md or xl?
          // adjust meta width
          labAd.meta.width = labAd.macros.width;
        }

        labAd.log({label: 'getDeviceSize ', detail: sz, type: 'log' });
        return sz;
      } catch (err) {
        labAd.log({label: 'getDeviceSize error: ', detail: err, type: 'error', isFatal: false });
      }
    }

    function getTestHash(){
      try {
        // expected format & order #adstest + cnd + dynght + deviceSize + dpr
        labAd.test.hashStr = top.window.location.hash.substring(1);
        // if this is a local file or gamPreview ith no adstest hash, assign default
        // hashStr value to eliminate need to manually add it to url
        if ((top.window.location.protocol === 'file:' || labAd.macros.gamPreview === 'true') && labAd.test.hashStr.indexOf('adstest') == -1) {
          // get actual deviceSize based on macro value to use as defualt
          labAd.deviceSize = getDeviceSize();
          // build array of default values mapped to labAd props so changes are automatically picked up here
          labAd.test.defaultHashParts = ['adstest', labAd.default.cnd, labAd.default.dynght, labAd.deviceSize, labAd.dpr, labAd.default.previewMode,];
          // set the missing hash by joining parts of this array to assemble default adstest hash string
          top.window.location.hash = labAd.test.defaultHashParts.join('+');
          // now get and use the hashtring
          labAd.test.hashStr = top.window.location.hash.substring(1);
          labAd.log({label: 'getTestHash defaultHashParts', detail: labAd.test.defaultHashParts, type: 'log' });
        }
        // split hash string on '+' delimiter
        labAd.test.hashArray = labAd.test.hashStr.split("+");
        // validate by filtering out empty values: "", undefined
        labAd.test.hashArrayFiltered = labAd.test.hashArray.filter(function (el) {
          return el != null && el != "";
        });

        labAd.log({label: 'getTestHash ', detail: labAd.test.hashArrayFiltered, type: 'log' });
        // return validated and sanitized array of #adstest hash values
        return labAd.test.hashArrayFiltered;
      } catch (err) {
        labAd.log({label: 'getTestHash error: ', detail: err, type: 'error', isFatal: false });
      }
    }

    function imgDPR(sFilename) {
      try {
        // apply img name based on devicePixelRatio (or argument representing dpr)
        // assuming all base filenames should contain '@1x'
        var imgName = decodeURIComponent(sFilename);
        var adjusted = 'not adjusted.';

        if (imgName.indexOf('@') != -1) { // if decoded filename contains @ symbol
          // make DPR adjustments using string replacement
          if (labAd.dpr > 3) {
            // greater than triple density
            imgName = imgName.replace('@1x', '@4x');
            adjusted = 'adjusted to 4x.';
          } else if (labAd.dpr > 2 && labAd.dpr <= 3) {
            // triple density
            imgName = imgName.replace('@1x', '@3x');
            adjusted = 'adjusted to 3x.';
          } else if (labAd.dpr > 1 && labAd.dpr <= 2) {
            // double density aka retina
            imgName = imgName.replace('@1x', '@2x');
            adjusted = 'adjusted to 2x.';
          } else {
            // no adjustment required since default is '@1x'
          }
          // log success
          labAd.log({label: 'imgDPR: '+ adjusted, detail: imgName, type: 'log' });
        } else {
          // warn in console for files missing @ symbol
          adjusted = '@ symbol not found in filename so imgDPR adjustment is not possible.'
          labAd.log({label: 'imgDPR: '+ adjusted, detail: imgName, type: 'warn' });
        }

        return imgName;
      } catch (err) {
        labAd.log({label: 'imgDPR error: ', detail: err, type: 'error', isFatal: false });
      }
    }

    function imgObj(sId, sSrc){
      try {
        // adjust dpr as needed
        var obj = {id: sId, src: imgDPR(sSrc)};
        // adjust image size of src
        obj.src = setSrcSize(obj.src);
        // prepend labAd.dir if src is not absolute path
        if (obj.src.indexOf('://') == -1) {
          obj.src = labAd.dir + obj.src;
        }
        // log results
        labAd.log({label: 'imgObj '+ sId + ' - ' + sSrc, detail: obj, type: 'log' });
        return obj;
      } catch (err) {
        labAd.log({label: 'imgObj error: ', detail: err, type: 'error', isFatal: true });
      }
    }

    function logInfo(oInfo){
      // save to logs array - regardless of type or details
      this.logs.push(oInfo);

      // console output format will correspond to type of info being logged.
      // only local files are eligible for console output.

      // steps for error logs
      if (oInfo.type === 'error') {
        // save to errors array
        this.errors.push(oInfo);
        // always output log errors so they cannot be suppressed/missed due to logLevel
        console[oInfo.type](oInfo);

        // if the error is fatal, call showDefault with label passed as reason
        if (oInfo.isFatal) {
          showDefault(oInfo.label);
        }
      }else{ // steps for non-error logs

        // console output is only possible if file is local
        if (window.location.href.indexOf("file://") != -1) {
          // adjust type/level of output based on labAd.logLevel
          switch (labAd.logLevel) {
            case 2:
              // output every individual log
              console[oInfo.type](oInfo);
              break;
            case 0:
              // output nothing to console
              break;
            default:
              // clear console since this can fire many times but we only need 1 output for this setting
              console.clear();

              // if there are errors, output them before labAd
              if (labAd.errors.length > 0) {
                labAd.errors.forEach(function(err, i){
                  console.error(err);
                })
              }

              // output labAd object for easy inspection
              console.log(labAd);
          }
        };
      }

      // update labInfo. Example: statefarm-4693437107-1528401281492
      setLabInfo(this.meta.advertiser + '-' + this.meta.placement + '-' + this.meta.width + 'x' + this.meta.height + '-' + this.time.date, this);
    }

    function logTime(sName){
        try {
          // log timing of key events to time.log for tracking purposes
          // also return getTime() value so this can be used to get timestamps
          var d = new Date();
          var order = Object.keys(labAd.time.log).length;
          // create new log obj
          labAd.time.log[sName] = {};
          // stamp this event
          labAd.time.log[sName].stamp = d.getTime();
          // calc split in ms from previous stamp
          if (sName != 'initAd') {
            labAd.time.log[sName].split = (labAd.time.log[sName].stamp - labAd.time.stamp);
          } else {
            labAd.time.log[sName].split = 0;
          }
          // calc elapsed from initAd - in ms
          labAd.time.log[sName].elapsed = (labAd.time.log[sName].stamp - labAd.time.log['initAd'].stamp);
          // capture log order to indicate where in sequence this log occured
          labAd.time.log[sName].order = order;

          // capture timestamp to use for next split
          labAd.time.stamp = d.getTime();

          return labAd.time.stamp;
        } catch (err) {
          labAd.log({label: 'logTime error: ', detail: err, type: 'error', isFatal: false });
        }
    }

    function setLabInfo(sName, obj) {
      try {
        // store passed object to labInfo on parent DOM if possible
        if (labAd.macros.gamPreview === 'true') {
          // skip logging if running in DFP Preview
          return;
        } else {
          parent.labInfo = parent.labInfo || {};
          parent.labInfo[sName] = obj;
        }
      } catch (err) {
        labAd.log({label: 'setLabInfo error: ', detail: err, type: 'error', isFatal: false });
      }
    }

    function setSrcSize(sFilename) {
      try {
        // perform string replacement to adjust from sm to lg image
        var imgName = decodeURIComponent(sFilename);
        var adjusted = 'not adjusted.';

        if (labAd.deviceSize != 'sm') {
          // Adjust to larger dimensions for non-small devices
          if (imgName.indexOf('320x180') != -1) {
            imgName = imgName.replace('320x180', '360x180');
            adjusted = "adjusted to 360x180."
          }
          if (imgName.indexOf('400x700') != -1 || imgName.indexOf('400x660') != -1) {
            imgName = imgName.replace('bde5532e-c1fb-44e1-b159-1b424d759c84/400x660-bg-dunkin-copy-clr-d@2x_HighRes_avc_mpeg4_1000kbps.mp4', '1274e8d8-9a2c-41a0-880e-84657e422b85/500x800-bg-dunkin-copy-clr-d@2x_HighRes_avc_mpeg4_1000kbps.mp4');
            imgName = imgName.replace('3f0e94cd-d464-492d-9f7d-625c2d7f5135/400x660-bg-dunkin-copy-clr-n@2x_HighRes_avc_mpeg4_1000kbps.mp4', 'c0d8ae56-801f-4a91-8383-5c0f7d85f7f1/500x800-bg-dunkin-copy-clr-n@2x_HighRes_avc_mpeg4_1000kbps.mp4');
            imgName = imgName.replace('5965c2e0-b785-4298-ad56-e27a68afad0a/400x660-bg-dunkin-copy-cld-d@2x_HighRes_avc_mpeg4_1000kbps.mp4', '8d416a32-c950-4d6b-888f-ca95eb8a7157/500x800-bg-dunkin-copy-cld-d@2x_HighRes_avc_mpeg4_1000kbps.mp4');
            imgName = imgName.replace('c094d434-dd9b-484b-8a9d-cce6cbd6bf93/400x660-bg-dunkin-copy-cld-n@2x_HighRes_avc_mpeg4_1000kbps.mp4', '3bbf89ee-0a2e-473d-9c28-efe9087ec61a/500x800-bg-dunkin-copy-cld-n@2x_HighRes_avc_mpeg4_1000kbps.mp4');
            imgName = imgName.replace('df06aa83-c2aa-4c86-8f12-437887600023/400x660-bg-dunkin-copy-rain-d@2x_HighRes_avc_mpeg4_1000kbps.mp4', '4f350111-44f5-417c-b254-061f11a3ae92/500x800-bg-dunkin-copy-rain-d@2x_HighRes_avc_mpeg4_1000kbps.mp4');
            imgName = imgName.replace('8267fabf-caa6-449a-b447-3837d366ff93/400x660-bg-dunkin-copy-rain-n@2x_HighRes_avc_mpeg4_1000kbps.mp4', '611ff9b4-30b2-46f6-94f2-3e67ed435cc8/500x800-bg-dunkin-copy-rain-n@2x_HighRes_avc_mpeg4_1000kbps.mp4');
            imgName = imgName.replace('92805e81-23c9-4faa-aa01-9ccef04b1b45/400x660-bg-dunkin-copy-snow-d@2x_HighRes_avc_mpeg4_1000kbps.mp4', '8f3e7c54-75a8-431a-a323-35bf19b3956f/500x800-bg-dunkin-copy-snow-d@2x_HighRes_avc_mpeg4_1000kbps.mp4');
            imgName = imgName.replace('b04c227a-dbf1-4435-aac3-168193a500bd/400x660-bg-dunkin-copy-snow-n@2x_HighRes_avc_mpeg4_1000kbps.mp4', '74dd3944-6361-4a39-8aca-d9719e0f7f2e/500x800-bg-dunkin-copy-snow-n@2x_HighRes_avc_mpeg4_1000kbps.mp4');
            imgName = imgName.replace('400x660', '500x800');
            imgName = imgName.replace('400x700', '500x800');
            adjusted = "adjusted to 500x800."
          }
        }else{
          adjusted = 'Milli device so no adjustment needed.'
        }

        // log success
        labAd.log({label: 'setSrcSize: '+ adjusted, detail: imgName, type: 'log' });

        return imgName;
      } catch (err) {
        labAd.log({label: 'setSrcSize error: ', detail: err, type: 'error', isFatal: false });
      }
    }

    function showAd(aLoadedImages) {
      try {
        if (!labAd.displayed) {
          // flag to prevent ad from displaying multiple times in the event of failure or timeout
          labAd.displayed = true;

          logTime('showAd');
          labAd.log({label: 'showAd: ', detail: aLoadedImages, type: 'log' });

          ////////////////////////////////////////////////
          // 1: Append AD Area (360x105 or 360x140) images to labAdDiv. //
          ////////////////////////////////////////////////
          aLoadedImages.forEach(function(elem) {// for each aLoadedImages el: assign CSS and behavior(s) then attach to DOM
            // add el reference to labAd.els
            labAd.els[elem.id] = elem;
            // assign common class to all
            labAd.els[elem.id].className = 'abs-' + labAd.deviceSize;
            labAd.els.labAdDiv.className = labAd.deviceSize;
            // append to labAdDiv
            labAd.els.labAdDiv.appendChild(labAd.els[elem.id]);
            // assign specific behavior/format by id
            if (elem.id === 'btnInv') { // assign click handler to invisible btn
              labAd.els[elem.id].onclick = exitClick;
            }
          });

        } else {
          var err = {message:'showAd called again.'}
          labAd.log({label: 'Display routine called after labAd.displayed === true.', detail: err, type: 'error', isFatal: false });
        }
      } catch (err) {
        labAd.log({label: 'showAd error: ', detail: err, type: 'error', isFatal: true });
      }
     }

    function showBg(bgProps){
      try {
        logTime('showBg');

        ///////////////////////////////////////////////////////////////////
        // 1: Process BG properties and fireAppEvent based on event name //
        ///////////////////////////////////////////////////////////////////
        if (bgProps.eventName === 'adBg') {
          // Static Image BG - assign props from selected
          labAd.appBg.baseURL = labAd.dir;
          // assign selected BG filename & adjust DPR if needed
          labAd.appBg.imgID = imgDPR(bgProps.fileName);
          // encode BG image name to prevent '@' from breaking app event.
          labAd.appBg.imgID = encodeURIComponent(labAd.appBg.imgID);
          // set the logical dimensions
          labAd.appBg.widthDP = bgProps.logicalWidth;
          labAd.appBg.heightDP = bgProps.logicalHeight;
           // fire the app event passing updated props
          fireAppEvent('adBg', labAd.appBg);

        } else { // Video BG
          // Assign bgProps.fileName overwrite to @2x video bg every time.
          labAd.appBgVid.vidURL = bgProps.fileName.replace('@1x','@2x');
          // encode vidURL - because '@' is not compatible with BG app events
          labAd.appBgVid.vidURL = encodeURIComponent(labAd.appBgVid.vidURL);
          // prepend labAd.dir to filename to form vidURL
          labAd.appBgVid.vidURL = labAd.dir + labAd.appBgVid.vidURL;
          // set the logical dimensions
          labAd.appBgVid.widthDP = bgProps.logicalWidth;
          labAd.appBgVid.heightDP = bgProps.logicalHeight;
          // Set the loopCount property
          labAd.appBgVid.loop = bgProps.loopCount;
           // fire the app event passing updated props
          fireAppEvent('adBgVid', labAd.appBgVid);

        }
      } catch (err) {
        labAd.log({label: 'showBg error: ', detail: err, type: 'error', isFatal: false });
      }
    }

    function showDefault(sReason) {
      try {
        if (!labAd.displayed) {
          // flag to prevent ad from displaying multiple times in the event of failure or timeout
          labAd.displayed = true;

          logTime('showDefault');
          labAd.default.reason = sReason;
          labAd.log({label: 'showDefault: ', detail: labAd.default.reason, type: 'log' });

          if (labAd.mode === 'live') {


          } else {
            // create error & reason output display for PreviewMode
            labAd.els.errOutput = document.createElement('div');
            labAd.els.errOutput.id = 'previewErrorOutput';
            // create and apppend heading
            labAd.els.errReason = document.createElement('h1');
            var t = document.createTextNode(sReason);
            labAd.els.errReason.appendChild(t);
            labAd.els.errOutput.appendChild(labAd.els.errReason);
            // create list
            labAd.els.errList = document.createElement('ol');
            // iterate errors and add list item for each
            labAd.errors.forEach(function(err, i){
              // create an li & text node for every error
              var li = document.createElement('li');
              var lit = document.createTextNode(err.label);
              li.appendChild(lit);
              // add li to the ul
              labAd.els.errList.appendChild(li);
            });

            // add ul with all list items to output panel
            labAd.els.errOutput.appendChild(labAd.els.errList);
            // create footer text
            var p = document.createElement('footer');
            p.innerHTML = '<strong>Note:</strong> The list above represents the earliest occuring errors - which should be diagnosed first. <p>Check <code>labAd.errors</code> for a complete set of errors and details.</p>';
            labAd.els.errOutput.appendChild(p);
            // empty previewMain and append the errOutput there because GAM Preview
            // will not permit insertBefore to place the errOutput before other
            // els in the DOM.
            labAd.els.previewMain.innerHTML = '';
            labAd.els.previewMain.appendChild(labAd.els.errOutput);
            labAd.els.previewMain.style.opacity = 1;
          }

        } else {
          var err = {message:'showDefault called again.'}
          labAd.log({label: 'Display routine called after labAd.displayed === true.', detail: err, type: 'error', isFatal: false });
        }

      } catch (err) {
        // not fatal since there's no fallback for this failure.
        labAd.log({label: 'showDefault error: ', detail: err, type: 'error', isFatal: false });
      }
    }

    document.addEventListener('DOMContentLoaded', initAd, false);
    </script>
    <style>
        /* CORE CSS - DO NOT EDIT  */
        /* VIEWABILITY FIX ADDED 11/18/19 - DO NOT REMOVE  */
        html {height: 100%; width: 100%;}
        body {margin: 0; height: 100%; width: 100%;}

        #labAdDiv {
          height: 180px;
          position: relative;
          margin: 0 auto;
        }

      #labAdDiv.sm {width: 320px; }
      #labAdDiv.md, #labAdDiv.lg, #labAdDiv.xl {width: 360px;}



      /* Ad Slot Size & Position */
      .abs-sm {width: 320px; height: 180px; position: absolute; }
      .abs-md, .abs-lg, .abs-xl {width: 360px; height: 180px; position: absolute;}


      .preview #labAdDiv.sm {width: 300px; bottom: 240%;}
      .preview #labAdDiv.md, .preview #labAdDiv.lg, .preview #labAdDiv.xl {width: 360px; left: 5%; bottom: 230%;}


      /* Ad Slot Size & Position */
      .preview .abs-sm { left: -8px; top: 23px;}
      .preview .abs-md, .preview .abs-lg, .preview .abs-xl { left: -18px; top: 10px;}


        #btnInv {
          z-index: 10;
          cursor: pointer;
        /*  background: rgba(255,255,255, .25);*/
        }

        /* btnInv element Position */
        .preview #btnInv.abs-md {top: 190px; left: -16px;}
        .preview #btnInv.abs-lg {top: -15px;}
        .preview #btnInv.abs-xl {top: 49px;}

        .hidden{opacity: 0;}
    /* END: CORE CSS - DO NOT EDIT  */

    /* Preview Mode CSS - DO NOT EDIT – VIEWABILITY FIX ADDED 11/18/19 */
        #previewMainContainer{opacity: 0; display: none;}
        #previewAltContainer{display: none;}
    /* END: Preview Mode CSS - DO NOT EDIT */
  </style>
  </head>

  <body>
    <!-- #labAdDiv is the main container for all AD elements -->
    <div id="labAdDiv"></div>

    <!-- Container for all tracking pixels - manually placed or dynamically generated. -->
    <div id="labTracking" style="display:none;">
      <!-- 3P IAS OR MOAT TRACKING GOES HERE IF APPLICABLE -->
    </div>

    <!-- Preview Mode Structure - DO NOT EDIT -->
    <div id="previewMainContainer">
  		<!-- LEFT FORM COL -->
  		<div id="previewColLeft">
  			<hr> <img id="previewFormLogo" src="" alt="IBM Watson Advertising">
  			<hr>
  			<p id="previewFormProduct"> Mobile App Integrated Marquee </p>
  			<hr>
  			<p id="previewFormClientName"> Client Name Here </p>
  			<hr>
  			<div id="previewFormDeviceSize">
  				<p>Device Size</p>
  				<!-- // added this for XL sizes preview - wodev comment-->
  				<input type="radio" name="deviceSize" value="sm" id="deviceSmall">
  				<label for="deviceSmall" id="label-01">SM</label>
  				<input type="radio" name="deviceSize" value="md" id="deviceMedium">
  				<label for="deviceMedium" id="label-02">RG</label>
  				<input type="radio" name="deviceSize" value="lg" id="deviceLarge">
  				<label for="deviceLarge" id="label-03">LG</label>
  				<input type="radio" name="deviceSize" value="xl" id="deviceXLarge">
  				<label for="deviceXLarge" id="label-04">XL</label>

  					<!-- // added this for medium sizes preview - wodev comment -->
  			</div>
  			<hr>
  			<div id="previewFormCondition">
  				<div id="btnPrevCond"><img src="https://s.w-x.co/cl/wxcl/preview-mode/idd/prev.png" /></div>
  						<div id="txtCondName"></div>
  				<div id="btnNextCond"><img src="https://s.w-x.co/cl/wxcl/preview-mode/idd/next.png" /></div>
  				</div>
  				<hr>
  				<div id="previewFormConditionIndex"></div>



  			</div>


  			<!-- RIGHT AD COL  -->
  			<div id="previewColRight">
          <div id="previewAppOverlay">
            <!-- previewAppOverlay = newer layout with images for device and app ui. -->
            <div id="previewDeviceToggleBtn"></div>
            <div id="previewDeviceOverlay"></div>
    		     <!-- START: ADD THIS for city, state textfield -->
            <div id="previewCityStateOverlay">
              <input type="text" id="cityStateInput" value="Durango, CO" readonly>
            </div>
    		     <!-- END: ADD THIS for city, state textfield -->
            <div id="previewUiCon">
              <div id="previewUiOverlay"></div>
            </div>
            <div id="previewUiFCOverlay"></div>
            <div id="previewBlockerBottom"></div>
          </div>
  				<div id="previewAppLayout">
  					<!-- previewAppLayout (previously previewAppContainer) = older layout with colored divs representing different regions of app. -->
  					<div id="previewAppHeader"></div>
  					<div id="previewAppToggle"></div>
  					<div id="previewAppChart"></div>
  					<div id="previewAppInsight"></div>
  					<div id="previewAppGradient"></div>
  					<div id="previewAppNav"></div>
  					<div id="previewAppCoverRight"></div>
  					<div id="previewAppCoverLeft"></div>
  				</div>
  				<!-- End Right Column -->
  			</div>
  		</div>
  		<div id="previewAltContainer"> <img id="previewAltLogo" src="" alt="IBM Watson Advertising">
  			<p>Please increase browser width to view creative preview form.</p>
  		</div>

  </body>
</html>
